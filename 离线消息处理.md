# 离线消息拉取

### 离线的好友怎么获取离线消息？

对于好友聊天这样的点对点传输，我们只需将离线消息存储在 DB 中，用户上线后执行一边离线消息的拉取即可

### 离线的群友怎么获取离线消息？

- 基本方案：在线的群友不存储消息，离线的群友才存储，这样将会带来问题，如果在线的群友因为网络问题导致推送异常，则会漏消息

- 优化的方案：不管全成员是否在线，都要先存储消息，在线的群友收到消息则直接删除，离线群友下次上线后再删除，这样相当于一条消息存储多份，
消息冗余，对存储介质造成了很大的浪费

- 二次优化方案：群消息实体存储一份，用户只冗余消息 ID，这个优化，对于消息投递，以及消息删除的核心流程没有影响，实践为：
  - 在线用户投递消息实体，ack 消息 ID
  - 离线用户先拉取消息 ID,再拉取消息实体，再 ack 消息 ID

- 终极方案：利用群消息的偏序特性优雅地实现只存储一份，这就意味着，每个用户只需要记录最近一次收到的消息 ID，而不用记录所有未收到的消息 ID 集合，
每当收在线消息 ack 时，以及拉取离线消息 ack 时，只需要更新这个最近一次收到的消息 ID 即可，对于在线的群友，收到群消息后，修改这个 `last_ack_msgid`，
对于离线的群友，拉取消息后，再修改这个 `last_ack_msgid`，但是此方案前提是，需要消息 ID 呈自增趋势
